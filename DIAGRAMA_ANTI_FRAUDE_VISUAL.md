# ğŸ” Diagrama del Sistema Anti-Fraude CDMX

## Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       APLICACIÃ“N MOBILE (PWA SUPER)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  BARRA VERDE (Reloj CDMX - No manipulable)                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚  â”‚ ğŸŸ¢ Conectado â€¢ 14:30:45  04/11/2025                      â”‚        â”‚  â”‚
â”‚  â”‚  â”‚ â† Verificado cada N segundos â† Viene del servidor        â”‚        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚  CaracterÃ­sticas:                                                     â”‚  â”‚
â”‚  â”‚  âœ… NO puede ser modificada por JavaScript                           â”‚  â”‚
â”‚  â”‚  âœ… Es la fuente Ãºnica de verdad                                     â”‚  â”‚
â”‚  â”‚  âœ… Se sincroniza constantemente con servidor                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PÃGINA HOME (Marcar Entrada/Salida)                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ”µ MARCAR ENTRADA   â”‚  â”‚ ğŸ”´ MARCAR SALIDA    â”‚                 â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚           â†“                           â†“                              â”‚  â”‚
â”‚  â”‚  const timestamp = obtenerTimestampCDMX()                           â”‚  â”‚
â”‚  â”‚  // "2025-11-04T14:30:45.123-06:00"  â† Timestamp verificable       â”‚  â”‚
â”‚  â”‚           â†“                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚ ğŸŒ MODO ONLINE         ğŸ“´ MODO OFFLINE             â”‚            â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ EnvÃ­a directamente:    Guarda en IndexedDB:       â”‚            â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ FormData {             {                           â”‚            â”‚  â”‚
â”‚  â”‚  â”‚  usuario_id: 123,        usuario_id: 123,         â”‚            â”‚  â”‚
â”‚  â”‚  â”‚  timestamp_offline:      tipo: 'entrada',         â”‚            â”‚  â”‚
â”‚  â”‚  â”‚    "2025-11-04...",    timestamp_cdmx:           â”‚            â”‚  â”‚
â”‚  â”‚  â”‚  foto: blob,            "2025-11-04...",         â”‚            â”‚  â”‚
â”‚  â”‚  â”‚  latitud: 19.4326,     foto_base64: "...",       â”‚            â”‚  â”‚
â”‚  â”‚  â”‚  longitud: -99.1332    latitud: 19.4326          â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ }                        longitud: -99.1332       â”‚            â”‚  â”‚
â”‚  â”‚  â”‚                         }                          â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SINCRONIZACIÃ“N (Cuando recupera conexiÃ³n)                           â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  IndexedDB â†’ syncService â†’ Usa timestamp_cdmx ORIGINAL               â”‚  â”‚
â”‚  â”‚  (NO la hora actual cuando sincroniza)                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â†“â†“â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  SERVIDOR BACKEND (VPS)        â”‚
                        â”‚  31.97.8.51                    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â†“â†“â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              VALIDACIÃ“N ANTI-FRAUDE (obtener_fecha_hora_cdmx)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Recibe: timestamp_offline = "2025-11-04T14:30:45.123-06:00"              â”‚
â”‚                                                                              â”‚
â”‚  Pasos de ValidaciÃ³n:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1ï¸âƒ£  Parse ISO String â†’ Convertir a CDMX                           â”‚   â”‚
â”‚  â”‚     "2025-11-04T14:30:45.123-06:00" â†’ datetime object             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2ï¸âƒ£  VALIDACIÃ“N ANTI-FRAUDE (core)                                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  ahora_servidor = datetime.now(CDMX_TZ) = 14:32:15                â”‚   â”‚
â”‚  â”‚  timestamp_cliente = 14:30:45                                      â”‚   â”‚
â”‚  â”‚  diferencia = 90 segundos                                          â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  if diferencia < 5 minutos (300s):                                â”‚   â”‚
â”‚  â”‚      âœ… ACEPTADO                                                   â”‚   â”‚
â”‚  â”‚      Registrar normalmente                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  elif diferencia 5-60 minutos:                                     â”‚   â”‚
â”‚  â”‚      âš ï¸  ALERTA                                                    â”‚   â”‚
â”‚  â”‚      Registrar pero log: "Usuario con diferencia de XXs"          â”‚   â”‚
â”‚  â”‚      Log: "Posible desincronizaciÃ³n de reloj"                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  elif diferencia > 60 minutos (3600s):                            â”‚   â”‚
â”‚  â”‚      âŒ RECHAZAR                                                   â”‚   â”‚
â”‚  â”‚      NO registrar                                                 â”‚   â”‚
â”‚  â”‚      Log: "âŒ FRAUDE DETECTADO: Usuario cambiÃ³ reloj"            â”‚   â”‚
â”‚  â”‚      Usar: ahora_servidor como fallback                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3ï¸âƒ£  Retornar Fecha/Hora Validadas                                 â”‚   â”‚
â”‚  â”‚     (fecha_cdmx, hora_cdmx, timestamp_for_filename)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4ï¸âƒ£  Guardar en Base de Datos                                       â”‚   â”‚
â”‚  â”‚     INSERT INTO asistencias                                        â”‚   â”‚
â”‚  â”‚     (usuario_id, fecha, hora_entrada, latitud, longitud, ...)     â”‚   â”‚
â”‚  â”‚     VALUES (123, '2025-11-04', '2025-11-04 14:30:45', ...)       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚     âœ… Hora guardada es EXACTAMENTE la que se marcÃ³              â”‚   â”‚
â”‚  â”‚     (DespuÃ©s de validaciÃ³n anti-fraude)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Fraude Previsto

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INTENTO DE FRAUDE: Cambiar Reloj Local                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  ESCENARIO:                                                                  â”‚
â”‚  - Usuario llegÃ³ a las 14:30                                                â”‚
â”‚  - Pero quiere registrarse a las 09:00                                       â”‚
â”‚  - Intenta cambiar reloj del telÃ©fono: 14:30 â†’ 09:00                        â”‚
â”‚                                                                               â”‚
â”‚  RESULTADO:                                                                  â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€ Usuario intenta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â”‚  Cambia Reloj: 09:00:00 â† â”€ â”€ â”€ â”                                     â”‚  â”‚
â”‚  â”‚                              Es visible pero no afecta al timestamp    â”‚  â”‚
â”‚  â”‚  Marca Entrada                    â”‚                                    â”‚  â”‚
â”‚  â”‚           â†“                       â”‚                                    â”‚  â”‚
â”‚  â”‚  obtenerTimestampCDMX()           â”‚                                    â”‚  â”‚
â”‚  â”‚           â†“                       â”‚                                    â”‚  â”‚
â”‚  â”‚  Retorna: "2025-11-04T09:00:45-06:00"  â† Timestamp generado con relojâ”‚  â”‚
â”‚  â”‚           â†“                                                             â”‚  â”‚
â”‚  â”‚  EnvÃ­a al servidor                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                               â”‚
â”‚  â”Œâ”€ Backend valida â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Recibe: timestamp_offline = "2025-11-04T09:00:45-06:00"              â”‚   â”‚
â”‚  â”‚  Hora servidor actual: 14:30:45                                        â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Calcula diferencia:                                                   â”‚   â”‚
â”‚  â”‚  14:30:45 - 09:00:45 = 5 horas 30 minutos = 19800 segundos          â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Compara con lÃ­mites:                                                  â”‚   â”‚
â”‚  â”‚  19800 segundos > 3600 segundos (1 hora)?                             â”‚   â”‚
â”‚  â”‚  SÃ â†’ âŒ RECHAZADO                                                    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Log generado:                                                         â”‚   â”‚
â”‚  â”‚  âŒ RECHAZO: Diferencia de timestamp > 1 hora (19800s)                â”‚   â”‚
â”‚  â”‚  ğŸš« Posible fraude: Usuario intentÃ³ cambiar su reloj                  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Fallback: Usar hora del servidor                                      â”‚   â”‚
â”‚  â”‚  ahora_servidor = 14:30:45 â† Se usa esta hora en su lugar            â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                               â”‚
â”‚  â”Œâ”€ Resultado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â”‚  âŒ Entrada RECHAZADA                                                 â”‚  â”‚
â”‚  â”‚     O Si se acepta por fallback:                                       â”‚  â”‚
â”‚  â”‚  âœ… Entrada registrada a las 14:30:45 (hora REAL del servidor)        â”‚  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â”‚  Usuario no puede hacer trampa â†’ Registra hora correcta               â”‚  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Endpoint de ValidaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GET /validar/sincronizacion-reloj                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  PropÃ³sito:                                                        â”‚
â”‚  - Cliente puede verificar que su reloj estÃ¡ sincronizado         â”‚
â”‚  - Comparar hora local vs servidor ANTES de marcar                â”‚
â”‚  - Detectar desincronizaciones preemptivamente                    â”‚
â”‚                                                                    â”‚
â”‚  Request:                                                          â”‚
â”‚  GET http://api.example.com/validar/sincronizacion-reloj          â”‚
â”‚                                                                    â”‚
â”‚  Response:                                                         â”‚
â”‚  {                                                                 â”‚
â”‚    "status": "ok",                                                â”‚
â”‚    "servidor_timestamp_cdmx": "2025-11-04T14:30:45.123-06:00",  â”‚
â”‚    "servidor_timestamp_utc": "2025-11-04T20:30:45.123+00:00",   â”‚
â”‚    "servidor_hora_legible": "14:30:45",                          â”‚
â”‚    "servidor_fecha": "04/11/2025",                               â”‚
â”‚    "zona_horaria": "America/Mexico_City (CDMX)"                  â”‚
â”‚  }                                                                 â”‚
â”‚                                                                    â”‚
â”‚  Cliente puede calcular:                                          â”‚
â”‚  diferencia = Date.now() - servidor_timestamp_cdmx               â”‚
â”‚                                                                    â”‚
â”‚  if (diferencia > 5 minutos):                                     â”‚
â”‚    Mostrar âš ï¸ "Tu reloj estÃ¡ desincronizado"                     â”‚
â”‚  else:                                                             â”‚
â”‚    âœ… "Tu reloj estÃ¡ sincronizado correctamente"                 â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ComparaciÃ³n: Antes vs DespuÃ©s

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ANTES âŒ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Usuario cambia reloj:                                           â”‚
â”‚  14:30 â†’ 09:00                                                   â”‚
â”‚         â†“                                                         â”‚
â”‚  Marca Entrada:                                                  â”‚
â”‚  Registra: 09:00 â† INCORRECTO                                    â”‚
â”‚         â†“                                                         â”‚
â”‚  Base de datos:                                                  â”‚
â”‚  hora_entrada = 09:00 âŒ (Falso)                                â”‚
â”‚         â†“                                                         â”‚
â”‚  AuditorÃ­a:                                                      â”‚
â”‚  Imposible verificar si es genuino o fraude                      â”‚
â”‚  Usuario aparenta que llegÃ³ temprano                             â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DESPUÃ‰S âœ…                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Usuario cambia reloj:                                           â”‚
â”‚  14:30 â†’ 09:00                                                   â”‚
â”‚         â†“                                                         â”‚
â”‚  Marca Entrada:                                                  â”‚
â”‚  Timestamp generado: 09:00 CDMX                                  â”‚
â”‚         â†“                                                         â”‚
â”‚  Backend valida:                                                 â”‚
â”‚  diferencia = 5.5 horas > 1 hora?                               â”‚
â”‚  SÃ â†’ âŒ RECHAZADO                                               â”‚
â”‚         â†“                                                         â”‚
â”‚  Resultado:                                                      â”‚
â”‚  âœ… Marca rechazada o                                            â”‚
â”‚  âœ… Registra 14:30 (hora real del servidor)                      â”‚
â”‚         â†“                                                         â”‚
â”‚  AuditorÃ­a:                                                      â”‚
â”‚  âœ… Log: "Intento de fraude detectado"                           â”‚
â”‚  âœ… Usuario NO puede hacer trampas                              â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## GarantÃ­a de Seguridad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Â¿POR QUÃ‰ ES IMPOSIBLE HACER TRAMPA?            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  1. RELOJ VERIFICABLE                                             â”‚
â”‚     â”œâ”€ No puede ser modificado por JavaScript                     â”‚
â”‚     â”œâ”€ Viene directamente del servidor                            â”‚
â”‚     â””â”€ Se sincroniza cada N segundos                              â”‚
â”‚                                                                    â”‚
â”‚  2. VALIDACIÃ“N DUAL                                               â”‚
â”‚     â”œâ”€ Frontend: obtenerTimestampCDMX() usa reloj actual         â”‚
â”‚     â”œâ”€ Backend: Valida contra hora del servidor                   â”‚
â”‚     â””â”€ Diferencia > 1 hora = Rechazo automÃ¡tico                   â”‚
â”‚                                                                    â”‚
â”‚  3. ALMACENAMIENTO OFFLINE SEGURO                                 â”‚
â”‚     â”œâ”€ Timestamp CDMX se guarda ANTES de perder conexiÃ³n         â”‚
â”‚     â”œâ”€ Al sincronizar, envÃ­a timestamp original                   â”‚
â”‚     â””â”€ NO puede cambiar la hora despuÃ©s de marcar                â”‚
â”‚                                                                    â”‚
â”‚  4. BASE DE DATOS EN SERVIDOR                                     â”‚
â”‚     â”œâ”€ Datos guardados en servidor (no navegador)                â”‚
â”‚     â”œâ”€ Usuario no tiene acceso para modificar                    â”‚
â”‚     â””â”€ Solo admin VPS puede cambiar (requiere credenciales)      â”‚
â”‚                                                                    â”‚
â”‚  5. LOGS Y AUDITORÃA                                              â”‚
â”‚     â”œâ”€ Todos los intentos de fraude quedan registrados           â”‚
â”‚     â”œâ”€ Diferencias > 5 minutos generan alerta                    â”‚
â”‚     â””â”€ Diferencias > 1 hora son rechazadas automÃ¡ticamente       â”‚
â”‚                                                                    â”‚
â”‚  CONCLUSIÃ“N:                                                       â”‚
â”‚  âœ… Es IMPOSIBLE hacer trampa cambiando reloj local              â”‚
â”‚  âœ… Cualquier intento es DETECTADO y REGISTRADO                  â”‚
â”‚  âœ… La HORA REAL siempre se guarda en la BD                      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Implementado:** 4 de Noviembre 2025  
**Status:** âœ… ACTIVO Y OPERATIVO  
**Seguridad:** ğŸ” MÃXIMA
